#!/usr/bin/make -f
#------------------------------------------------------------------------------
# DevinD Makefile
#------------------------------------------------------------------------------
# Project      : DevinD (Dev in Docker)
# Description  : Executable Makefile wrapper to run development tasks across
#                multiple environments (local, Docker, remote via SSH, remote Docker)
#                without modifying the original Makefiles. Acts as a flexible
#                buildflow orchestrator using environment-specific profiles.
# Author       : Oliveira S.
# Version      : NA
# License      : MIT
# Repository   : https://gitlab.com/oliveira.s/devind
#------------------------------------------------------------------------------
# Usage        : ./devind [target]
#------------------------------------------------------------------------------
# Notes:
# - This Makefile is designed to run as an executable script.
# - Supports execution in various environments defined in `devind.yaml`.
#------------------------------------------------------------------------------

DEVIND_MAKEFILE_ENTRY ?= example/hello-world/Makefile
DEVIND_FOLDER ?= .devind

# Include devtarget mapping
include $(DEVIND_FOLDER)/devtargets.mk

# Verbosity selection
ifeq ($(V),1)
QUIET := 
else
QUIET := @
endif

.DEFAULT_GOAL := generate

# Devind Folder Creation
$(DEVIND_FOLDER):
	$(info [CONF] Creating DevinD folder: $@)
	$(QUIET)mkdir $@

# Configure devind
.PHONY: configure-devind
configure-devind: | $(DEVIND_FOLDER)

.PHONY: generate
generate:
	@true
	$(info [CONF] Generating DevinD definition Makefile)

# --- Target runner for DevTarget ---
# This rule dynamically runs the target in the selected environment profile.
.PHONY: devind-target-runner
devind-target-runner:
	$(eval DEVIND_DEVTARGET := $(call devtarget_for_goal,$(GOAL)))
	$(eval include $(DEVIND_FOLDER)/env/$(DEVIND_DEVTARGET).mk)

	$(info [EXEC] Running make target `$(GOAL)` in devtarget: $(DEVIND_DEVTARGET))
	$(QUIET) $(CMD_PREFIX) "$(GOAL)" $(CMD_SUFFIX)


# Rule to run goals on the configured dev target
# Each goal runs the internal target runner, setting necessary variables and invoking the appropriate profile
%:
	$(QUIET) $(MAKE) -f $(firstword $(MAKEFILE_LIST)) devind-target-runner GOAL=$@ \
		DEVIND_MAKEFILE_ENTRY=$(DEVIND_MAKEFILE_ENTRY) \
		DEVIND_FOLDER=$(DEVIND_FOLDER)
